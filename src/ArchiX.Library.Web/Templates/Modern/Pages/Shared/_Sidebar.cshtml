<nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar">
    <div class="sidebar-header">
        <h3><i class="bi bi-grid-fill"></i> Menü</h3>

        <!-- Desktop collapse/expand button (right-top icon) -->
        <button class="sidebar-toggle-btn" type="button" id="sidebarCollapseToggle" aria-label="Toggle sidebar">
            <i class="bi bi-chevron-left"></i>
        </button>
    </div>

    <div class="position-sticky pt-3">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link @(ViewContext.RouteData.Values["page"]?.ToString() == "/Dashboard" ? "active" : "")"
                   asp-page="/Dashboard">
                    <i class="bi bi-house-door-fill"></i>
                    Ana Sayfa
                </a>
            </li>

            <!-- Tools / Dataset (Collapsible) - default CLOSED -->
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#toolsDatasetMenu" data-archix-group="Tools/Dataset"
                   role="button" aria-expanded="false" aria-controls="toolsDatasetMenu">
                    <i class="bi bi-table"></i>
                    Dataset Tools
                    <i class="bi bi-chevron-down float-end"></i>
                </a>

                <div class="collapse" id="toolsDatasetMenu">
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item">
                            <a class="nav-link" href="/Tools/Dataset/Grid" data-archix-menu="Tools/Dataset/Grid">
                                <i class="bi bi-list-check"></i>
                                Dataset Grid
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/Tools/Dataset/Kombine" data-archix-menu="Tools/Dataset/Kombine">
                                <i class="bi bi-intersect"></i>
                                Dataset Kombine
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/Tools/Dataset/Record" data-archix-menu="Tools/Dataset/Record">
                                <i class="bi bi-ui-checks-grid"></i>
                                Dataset Record
                            </a>
                        </li>
                    </ul>
                </div>
            </li>

            <!-- Definitions (Tanımlar) - Admin üstünde - default CLOSED -->
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#definitionsMenu" data-archix-group="Definitions"
                   role="button" aria-expanded="false" aria-controls="definitionsMenu">
                    <i class="bi bi-folder2-open"></i>
                    Definitions
                    <i class="bi bi-chevron-down float-end"></i>
                </a>

                <div class="collapse" id="definitionsMenu">
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item">
                            <a class="nav-link" href="/Definitions/Application" data-archix-menu="Definitions/Application">
                                Application
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/Definitions/Parameters" data-archix-menu="Definitions/Parameters">
                                Parameters
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/Definitions/Datasets" data-archix-menu="Definitions/Datasets">
                                Datasets
                            </a>
                        </li>
                    </ul>
                </div>
            </li>

            <!-- Admin Menu - default CLOSED -->
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="collapse" href="#adminMenu" data-archix-group="Admin"
                   role="button" aria-expanded="false" aria-controls="adminMenu">
                    <i class="bi bi-tools"></i>
                    Admin
                    <i class="bi bi-chevron-down float-end"></i>
                </a>

                <div class="collapse" id="adminMenu">
                    <ul class="nav flex-column ms-3">

                        <!-- Admin / Security - default CLOSED -->
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="collapse" href="#adminSecurityMenu" data-archix-group="Admin/Security"
                               role="button" aria-expanded="false" aria-controls="adminSecurityMenu">
                                <i class="bi bi-shield-lock-fill"></i>
                                Security
                                <i class="bi bi-chevron-down float-end"></i>
                            </a>

                            <div class="collapse" id="adminSecurityMenu">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Security/Index">Index aaa</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Security/Blacklist">Blacklist</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Security/PolicySettings">PolicySettings</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Security/PasswordPolicy">PasswordPolicy</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Security/AuditTrail">AuditTrail</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Security/PasswordHistory">PasswordHistory</a></li>
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Security/PolicyTest">PolicyTest</a></li>
                                </ul>
                            </div>
                        </li>

                        <!-- Admin / Reports - default CLOSED -->
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="collapse" href="#adminReportsMenu" data-archix-group="Admin/Reports"
                               role="button" aria-expanded="false" aria-controls="adminReportsMenu">
                                <i class="bi bi-graph-up"></i>
                                Reports
                                <i class="bi bi-chevron-down float-end"></i>
                            </a>

                            <div class="collapse" id="adminReportsMenu">
                                <ul class="nav flex-column ms-3">
                                    <li class="nav-item"><a class="nav-link" href="/Admin/Reports/DatasetParameters" data-archix-menu="Admin/Reports/DatasetParameters">DatasetParameters</a></li>
                                </ul>
                            </div>
                        </li>

                    </ul>
                </div>
            </li>

            <!-- Ayarlar -->
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="bi bi-gear-fill"></i>
                    Ayarlar
                </a>
            </li>

            <li class="nav-item mt-3">
                <hr class="text-white-50">
            </li>
        </ul>
    </div>
</nav>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');

        const LS_KEY = {
            collapsed: 'archix.sidebar.collapsed',
            openMenus: 'archix.sidebar.openMenus'
        };

        function readOpenMenus() {
            try {
                const raw = localStorage.getItem(LS_KEY.openMenus);
                if (!raw) return [];
                const arr = JSON.parse(raw);
                return Array.isArray(arr) ? arr : [];
            } catch {
                return [];
            }
        }

        function forceAllMenusClosedOnLoad() {
            // Force-close any open collapses on first load.
            // This ensures a consistent default of "all closed" including nested levels.
            document.querySelectorAll('#sidebar .collapse.show').forEach(function (c) {
                c.classList.remove('show');
                const id = c.id;
                if (!id) return;
                const toggle = document.querySelector(`#sidebar [href="#${id}"][data-bs-toggle="collapse"]`);
                if (toggle) toggle.setAttribute('aria-expanded', 'false');
            });
        }

        function writeOpenMenus(ids) {
            try {
                localStorage.setItem(LS_KEY.openMenus, JSON.stringify(ids || []));
            } catch { }
        }

        function applyStoredMenus() {
            const openMenus = readOpenMenus();
            document.querySelectorAll('.collapse[id]').forEach(function (c) {
                const id = c.id;
                if (!id) return;

                const shouldBeOpen = openMenus.indexOf(id) !== -1;

                // IMPORTANT: restoring state must not trigger Bootstrap collapse transitions.
                // Otherwise, when TabHost opens a tab and we re-apply sidebar state, the user sees
                // a visible close/open flicker.
                c.classList.toggle('show', shouldBeOpen);

                const toggle = document.querySelector(`[href="#${id}"][data-bs-toggle="collapse"]`);
                if (toggle) toggle.setAttribute('aria-expanded', shouldBeOpen ? 'true' : 'false');
            });

            const shouldBeCollapsed = isCollapsedStored();
            sidebar.classList.toggle('collapsed', shouldBeCollapsed);
            syncCollapseIcon();
        }

        // Expose a stable API for other scripts (TabHost) to re-apply sidebar state.
        window.ArchiX = window.ArchiX || {};
        window.ArchiX.Sidebar = window.ArchiX.Sidebar || {};
        window.ArchiX.Sidebar.restoreState = applyStoredMenus;

        function isCollapsedStored() {
            try { return localStorage.getItem(LS_KEY.collapsed) === '1'; } catch { return false; }
        }

        function setCollapsedStored(v) {
            try { localStorage.setItem(LS_KEY.collapsed, v ? '1' : '0'); } catch { }
        }

        function syncCollapseIcon() {
            const sidebarCollapseToggle = document.getElementById('sidebarCollapseToggle');
            if (!sidebarCollapseToggle || !sidebar) return;

            const icon = sidebarCollapseToggle.querySelector('i');
            if (!icon) return;

            const isCollapsed = sidebar.classList.contains('collapsed');
            icon.classList.toggle('bi-chevron-left', !isCollapsed);
            icon.classList.toggle('bi-chevron-right', isCollapsed);
        }

        // Initial state: always start with all menus closed.
        // Any persisted open menu state can cause partially-open (2nd level) UI on first load.
        try { writeOpenMenus([]); } catch { }
        try { forceAllMenusClosedOnLoad(); } catch { }

        // Track collapse menu open/close (bootstrap collapse events)
        document.querySelectorAll('.collapse[id]').forEach(function (c) {
            c.addEventListener('shown.bs.collapse', function (e) {
                // Only persist when the user explicitly toggled via a sidebar collapse header.
                // If some other script/interaction triggers collapse, we immediately restore stored state.
                const active = document.activeElement;
                const fromSidebarToggle = !!(active && active instanceof Element && active.closest('#sidebar') && active.hasAttribute('data-bs-toggle'));
                if (!fromSidebarToggle) {
                    try { applyStoredMenus(); } catch { }
                    return;
                }

                const ids = readOpenMenus();
                const id = e.target && e.target.id;
                if (!id) return;
                if (ids.indexOf(id) === -1) ids.push(id);
                writeOpenMenus(ids);
            });

            c.addEventListener('hidden.bs.collapse', function (e) {
                const active = document.activeElement;
                const fromSidebarToggle = !!(active && active instanceof Element && active.closest('#sidebar') && active.hasAttribute('data-bs-toggle'));
                if (!fromSidebarToggle) {
                    try { applyStoredMenus(); } catch { }
                    return;
                }

                const ids = readOpenMenus();
                const id = e.target && e.target.id;
                if (!id) return;
                const next = ids.filter(x => x !== id);
                writeOpenMenus(next);

                const toggle = document.querySelector(`[href="#${id}"][data-bs-toggle="collapse"]`);
                if (toggle) toggle.setAttribute('aria-expanded', 'false');
            });
        });

        // Mobile (<=768): CSS expects #sidebar.active
        const sidebarToggle = document.getElementById('sidebarToggle');
        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', function () {
                sidebar.classList.toggle('active');
            });
        }

        // Desktop: collapse/expand (CSS expects .sidebar.collapsed)
        const sidebarCollapseToggle = document.getElementById('sidebarCollapseToggle');
        if (sidebarCollapseToggle && sidebar) {
            sidebarCollapseToggle.addEventListener('click', function () {
                sidebar.classList.toggle('collapsed');
                setCollapsedStored(sidebar.classList.contains('collapsed'));
                syncCollapseIcon();
            });
        }

        // Intentionally do not force sidebar state on every link click here.
        // TabHost intercepts navigation globally; restoring state in both places can cause flicker.
    });
</script>
