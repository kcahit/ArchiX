@model ArchiX.Library.Web.ViewModels.Grid.DatasetSelectorViewModel

@if (Model.IsVisible)
{
    <div class="d-flex align-items-center gap-2">
        <select class="form-select form-select-sm" id="@Model.Id-datasetSelect" style="min-width:220px;height:32px;padding-top:0;padding-bottom:0;">
            <option value="">@Model.Placeholder</option>
            @foreach (var opt in (Model.Options ?? Array.Empty<ArchiX.Library.Web.ViewModels.Grid.ReportDatasetOptionViewModel>()))
            {
                if (Model.SelectedReportDatasetId.HasValue && Model.SelectedReportDatasetId.Value == opt.Id)
                {
                    <option value="@opt.Id" selected="selected">@opt.DisplayName</option>
                }
                else
                {
                    <option value="@opt.Id">@opt.DisplayName</option>
                }
            }
        </select>

        <button type="button"
                class="btn btn-primary btn-sm grid-btn-reset"
                style="height:32px;width:32px;padding:0;"
                id="@Model.Id-runReportBtn"
                data-endpoint="@Model.RunEndpoint"
                data-loading-message="Raporlar yüklenecek..."
                title="@Model.RunText"
                aria-label="@Model.RunText">
            <i class="bi bi-arrow-right-circle-fill text-white"></i>
        </button>
    </div>

    <script>
        (function () {
            var id = '@Model.Id';
            var select = document.getElementById(id + '-datasetSelect');
            var btn = document.getElementById(id + '-runReportBtn');

            if (!select || !btn) return;

            var lastSuccessful = null;

            function updateEnabled() {
                var v = select.value || '';
                var hasSelection = v.length > 0;
                var changedSinceLastRun = (lastSuccessful === null) || (lastSuccessful !== v);
                btn.disabled = !(hasSelection && changedSinceLastRun);
            }

            select.addEventListener('change', function () {
                updateEnabled();
            });

            btn.addEventListener('click', async function () {
                var endpoint = btn.getAttribute('data-endpoint') || '';
                var v = select.value || '';

                // fail-closed (endpoint veya seçim yoksa POST atma)
                if (!endpoint || !v) {
                    updateEnabled();
                    return;
                }

                var loadingMessage = btn.getAttribute('data-loading-message') || 'Raporlar yüklenecek...';
                try { alert(loadingMessage); } catch (e) { }

                btn.disabled = true;

                try {
                    // Revize #11: Standart form post (application/x-www-form-urlencoded)
                    var body = new URLSearchParams();
                    body.set('reportDatasetId', v);

                    // (opsiyonel) Sayfada mevcutsa p_* prefix'li form alanlarını aynı POST'a ekle.
                    // Not: Şu an sayfalarda p_* input olmayabilir; bu sadece #11 uyumluluğu için hazır.
                    var inputs = document.querySelectorAll('input[name^="p_"], select[name^="p_"], textarea[name^="p_"]');
                    for (var i = 0; i < inputs.length; i++) {
                        var el = inputs[i];
                        if (!el || !el.name) continue;

                        // checkbox/radio temel desteği
                        if ((el.type === 'checkbox' || el.type === 'radio') && !el.checked) continue;

                        body.set(el.name, (el.value ?? ''));
                    }

                    var res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
                        body: body.toString()
                    });

                    if (!res.ok) throw new Error('HTTP ' + res.status);

                    lastSuccessful = v;
                    updateEnabled();
                } catch (e) {
                    btn.disabled = false;
                }
            });

            updateEnabled();
        })();
    </script>
}