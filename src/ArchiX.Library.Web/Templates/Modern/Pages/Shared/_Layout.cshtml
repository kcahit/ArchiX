@using Microsoft.Extensions.Configuration
@using Microsoft.Extensions.Options
@using Microsoft.Extensions.Logging
@using ArchiX.Library.Web.Configuration
@using ArchiX.Library.Services.Parameters
@inject IConfiguration Configuration
@inject IParameterService ParameterService
@{
    Layout = "~/Pages/Shared/_ModernBaseLayout.cshtml";
    var pageTitle = ViewData["Title"]?.ToString() ?? "ArchiX";

    // #57 DB'den parametreleri oku (applicationId=1)
    TabbedOptions? tabbedOptions = null;
    UiTimeoutOptions? timeoutOptions = null;
    
    tabbedOptions = await ParameterService.GetParameterAsync<TabbedOptions>("UI", "TabbedOptions", applicationId: 1);
    timeoutOptions = await ParameterService.GetParameterAsync<UiTimeoutOptions>("UI", "TimeoutOptions", applicationId: 1);

    var isTabRequest = false;
    try
    {
        isTabRequest = string.Equals(Context?.Request?.Headers["X-ArchiX-Tab"].ToString(), "1", StringComparison.OrdinalIgnoreCase);
    }
    catch
    {
        isTabRequest = false;
    }


    var layoutProbeEnabled = false;
    try
    {
        var raw = Context?.Request?.Query["layoutProbe"].ToString();
        if (!string.IsNullOrWhiteSpace(raw))
        {
            raw = raw.Trim();
            layoutProbeEnabled = raw == "1" || raw.Equals("true", StringComparison.OrdinalIgnoreCase) || raw.Equals("yes", StringComparison.OrdinalIgnoreCase);
        }
    }
    catch
    {
        layoutProbeEnabled = false;
    }

    // Debug mode için ViewBag inject (#55)
    ViewBag.DebugMode = Configuration.GetValue<bool>("ArchiX:Debug", false);
}

@section Head {
    <title>@pageTitle - ArchiX</title>
}

@section Styles {
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

    <!-- Modern Template CSS -->
    <link rel="stylesheet" href="~/css/modern/main.css" asp-append-version="true" />

    <link rel="stylesheet" href="~/css/tabhost.css" asp-append-version="true" />

    @await RenderSectionAsync("Styles", required: false)
}

@section Header {
    @if (!isTabRequest)
    {
        @await Html.PartialAsync("Templates/Modern/Pages/Shared/_Navbar")
    }
}

@* Layout content (#55 Faze 2): Conditional required for RenderBody() - cannot extract to partial/component *@
@if (!isTabRequest)
{
    @* Full layout mode (direct page access) *@
    <div class="container-fluid h-100 px-0">
        <div class="row dashboard-layout-row g-0">
            @await Html.PartialAsync("Templates/Modern/Pages/Shared/_Sidebar")

            <div class="col-md-9 col-lg-10 main-content h-100">
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                }

                <div id="archix-tabhost">
                    <ul id="archix-tabhost-tabs" class="nav nav-tabs" role="tablist"></ul>
                    <div id="archix-tabhost-panes" class="tab-content"></div>
                </div>

                <div id="tab-main" class="archix-work-area px-2">
                    @RenderBody()
                </div>
            </div>
        </div>
    </div>
}
else
{
    @* Minimal layout mode (tab request - X-ArchiX-Tab: 1) *@
    <div id="tab-main" class="archix-work-area px-2">
        @RenderBody()
    </div>
}

@section Footer {
    @if (!isTabRequest)
    {
        @await Html.PartialAsync("Templates/Modern/Pages/Shared/_Footer")
    }
}

@section Scripts {
    @if (!isTabRequest)
    {
        <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

        <script src="~/js/archix/session-guard.js" asp-append-version="true"></script>
        <script src="~/js/archix/ui-options.js" asp-append-version="true"></script>
        
        <!-- #57 Inject UI parameters from DB -->
        <script>
            if (!window.ArchiX) window.ArchiX = {};
            
            // UI/TabbedOptions (DB'den)
            window.ArchiX.UiOptions = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(tabbedOptions, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
            
            // UI/TimeoutOptions (DB'den)
            window.ArchiX.TimeoutOptions = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(timeoutOptions, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
        </script>
        
        <script src="~/js/archix/tabbed/archix-tabhost.js" asp-append-version="true"></script>

        <!-- Debug mode setup (#55) -->
        <script>
            if (!window.ArchiX) window.ArchiX = {};
            window.ArchiX.Debug = @(ViewBag.DebugMode?.ToString().ToLower() ?? "false")
        </script>
        <script src="~/js/archix/diagnostics.js" asp-append-version="true"></script>
    }

    @if (layoutProbeEnabled)
    {
        <!-- ArchiX layoutProbe enabled (Templates/Modern/Pages/Shared/_Layout.cshtml) -->
        <script src="~/js/dev/archix-layout-probe.js" asp-append-version="true"></script>
    }

    @await RenderSectionAsync("Scripts", required: false)
}
