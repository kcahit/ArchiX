@page "/Raporlar/Kombine"
@model ArchiX.Library.Web.Templates.Modern.Pages.Raporlar.KombineModel
@using System
@using System.Linq
@using System.Collections.Generic
@using ArchiX.Library.Web.ViewModels.Grid
@{
    ViewData["Title"] = "Kombine Rapor";
    Layout = "~/Templates/Modern/Pages/Shared/_Layout.cshtml";

    // Öncelik: gerçek dataset sonucu varsa onu göster.
    IReadOnlyList<GridColumnDefinition> columns = (Model.Columns != null && Model.Columns.Count > 0)
        ? Model.Columns
        : new List<GridColumnDefinition>
        {
            new("id", "ID", "number"),
            new("name", "İsim"),
            new("department", "Departman"),
            new("position", "Pozisyon"),
            new("city", "Şehir"),
            new("salary", "Maaş", "number"),
            new("status", "Durum")
        };

    IEnumerable<IDictionary<string, object?>> rows = (Model.Rows != null && Model.Rows.Any())
        ? Model.Rows
        : Model.SampleData.Select(x => (IDictionary<string, object?>)new Dictionary<string, object?>
        {
            ["id"] = x.Id,
            ["name"] = x.Name,
            ["department"] = x.Department,
            ["position"] = x.Position,
            ["city"] = x.City,
            ["salary"] = x.Salary,
            ["status"] = x.Status
        }).ToList();

    var totalRecords = rows is ICollection<IDictionary<string, object?>> c ? c.Count : rows.Count();
}

@section Styles {
    <link rel="stylesheet" href="~/lib/pivottable/pivot.min.css">
    <link rel="stylesheet" href="~/lib/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/archix.reports.header.css">
    <link rel="stylesheet" href="~/css/modern/main.css">
}

<div class="container py-4">

    @await Component.InvokeAsync("GridToolbar", new GridToolbarViewModel
    {
        Id = "kombineGrid",
        TotalRecords = totalRecords,
        SearchPlaceholder = "Tüm alanlarda ara...",
        ResetText = "Sıfırla",
        ShowAdvancedSearch = true,
        ShowExport = true,
        IncludeAdvancedSearchPanel = true,

        ShowDatasetSelector = true,
        DatasetOptions = Model.DatasetOptions,
        SelectedReportDatasetId = Model.SelectedReportDatasetId,
        RunReportEndpoint = "/Raporlar/Kombine?handler=Run",
        RunReportText = "Raporla",
        DatasetPlaceholder = "Rapor seçin..."
        })

    <div class="accordion" id="reportsAccordion">
        <div class="accordion-item mb-3">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pivotSection">
                    <i class="bi bi-grid-3x3-gap-fill me-2"></i> Pivot Analiz
                </button>
            </h2>
            <div id="pivotSection" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div id="pivotContainer"></div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#gridSection">
                    <i class="bi bi-table me-2"></i> Detaylı Liste
                </button>
            </h2>
            <div id="gridSection" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    @await Component.InvokeAsync("GridTable", new GridTableViewModel
                                        {
                        Id = "kombineGrid",
                                        Title = "Detaylı Liste",
                                        SearchPlaceholder = "Tüm alanlarda ara...",
                                        Columns = columns,
                                        Rows = rows,
                                        ShowActions = false,
                                        ShowToolbar = false
                                        })
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script src="~/lib/jquery-ui/jquery-ui.min.js"></script>
    <script src="~/lib/pivottable/pivot.min.js"></script>
    <script src="~/lib/pivottable/pivot.tr.js"></script>

    <script type="application/json" id="kombineDataJson">
        @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SampleData))
    </script>

    <script>
        $(function () {
            const raw = document.getElementById('kombineDataJson')?.textContent ?? '[]';
            const data = JSON.parse(raw);

            if (typeof $.fn.pivotUI === 'function' && data) {
                $('#pivotContainer').pivotUI(data, {
                    rows: ['Department', 'City'],
                    cols: ['Status'],
                    vals: ['Salary'],
                    aggregatorName: 'Sum',
                    rendererName: 'Table Barchart'
                }, true, 'tr');
            }
        });
    </script>
}