@page "/Raporlar/Kombine"
@model ArchiX.Library.Web.Templates.Modern.Pages.Raporlar.KombineModel
@using ArchiX.Library.Web.ViewModels.Grid
@{
    ViewData["Title"] = "Kombine Rapor";
    Layout = "~/Templates/Modern/Pages/Shared/_Layout.cshtml";

    // Şimdilik örnek seçenekler (Approved datasetler gerçek DB'den geleceğinde burası değişecek)
    var datasetOptions = new List<ReportDatasetOptionViewModel>
    {
        new(1, "Örnek Rapor 1"),
        new(2, "Örnek Rapor 2"),
        new(3, "Örnek Rapor 3")
    };

    var columns = new List<GridColumnDefinition>
    {
        new("id", "ID", "number"),
        new("name", "İsim"),
        new("department", "Departman"),
        new("position", "Pozisyon"),
        new("city", "Şehir"),
        new("salary", "Maaş", "number"),
        new("status", "Durum")
    };

    var rows = Model.SampleData.Select(x => new Dictionary<string, object?>
    {
        ["id"] = x.Id,
        ["name"] = x.Name,
        ["department"] = x.Department,
        ["position"] = x.Position,
        ["city"] = x.City,
        ["salary"] = x.Salary,
        ["status"] = x.Status
    }).ToList();
}

@section Styles {
    <link rel="stylesheet" href="~/lib/pivottable/pivot.min.css">
    <link rel="stylesheet" href="~/lib/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="~/css/archix.reports.header.css">
    <link rel="stylesheet" href="~/css/modern/main.css">
}

<div class="container py-4">

    @* Sözleşme: DatasetSelector → Toolbar → Pivot → Grid *@
    @await Component.InvokeAsync("DatasetSelector", new DatasetSelectorViewModel
    {
        Id = "kombineGrid",
        IsVisible = true,
        Options = datasetOptions,
        SelectedReportDatasetId = null,
        RunEndpoint = "/Raporlar/Kombine?handler=Run",
        RunText = "Raporla",
        Placeholder = "Rapor seçin...",
        Mode = DatasetSelectorMode.GridMultiRow
    })

    @await Component.InvokeAsync("GridToolbar", new GridToolbarViewModel
    {
        Id = "kombineGrid",
        TotalRecords = Model.SampleData.Count,
        SearchPlaceholder = "Tüm alanlarda ara...",
        ResetText = "Sıfırla",
        ShowAdvancedSearch = true,
        ShowExport = true,
        IncludeAdvancedSearchPanel = true,

        // Toolbar embed (layout tutarlılığı) devam ediyor
        ShowDatasetSelector = true,
        DatasetOptions = datasetOptions,
        SelectedReportDatasetId = null,
        RunReportEndpoint = "/Raporlar/Kombine?handler=Run",
        RunReportText = "Raporla",
        DatasetPlaceholder = "Rapor seçin..."
    })

    <div class="accordion" id="reportsAccordion">
        <div class="accordion-item mb-3">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pivotSection">
                    <i class="bi bi-grid-3x3-gap-fill me-2"></i> Pivot Analiz
                </button>
            </h2>
            <div id="pivotSection" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <div id="pivotContainer"></div>
                </div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#gridSection">
                    <i class="bi bi-table me-2"></i> Detaylı Liste
                </button>
            </h2>
            <div id="gridSection" class="accordion-collapse collapse show">
                <div class="accordion-body">
                    @await Component.InvokeAsync("GridTable", new GridTableViewModel
                    {
                        Id = "kombineGrid",
                        Title = "Detaylı Liste",
                        SearchPlaceholder = "Tüm alanlarda ara...",
                        Columns = columns,
                        Rows = rows,
                        ShowActions = false,
                        ShowToolbar = false
                    })
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>
    <script src="~/lib/jquery-ui/jquery-ui.min.js"></script>
    <script src="~/lib/pivottable/pivot.min.js"></script>
    <script src="~/lib/pivottable/pivot.tr.js"></script>
    <script>
        window.kombineDataRaw = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SampleData));
        $(function () {
            if (typeof $.fn.pivotUI === 'function' && window.kombineDataRaw) {
                $('#pivotContainer').pivotUI(window.kombineDataRaw, {
                    rows: ['Department', 'City'],
                    cols: ['Status'],
                    vals: ['Salary'],
                    aggregatorName: 'Sum',
                    rendererName: 'Table Barchart'
                }, true, 'tr');
            }
        });
    </script>
}
