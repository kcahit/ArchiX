@page "{applicationId:int?}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Policy = ArchiX.Library.Abstractions.Security.PolicyNames.Admin)]
@model ArchiX.Library.Web.Pages.Admin.Security.PasswordPolicyModel
@{
    ViewData["Title"] = "Parola Politikasý";
    Layout = "_AdminLayout";
    var appId = Model.ApplicationId > 0 ? Model.ApplicationId : 1;
}

<div class="container-fluid py-3">
    <h2 class="mb-3"><i class="fas fa-file-code me-2"></i>JSON Editör - Parola Politikasý</h2>

    <div class="mb-3">
        <form method="get" class="row gy-2 gx-2 align-items-end">
            <div class="col-auto">
                <label for="appId" class="form-label">Application Id</label>
                <input id="appId" name="applicationId" type="number" min="1" class="form-control" value="@appId" />
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-outline-secondary">Yükle</button>
            </div>
        </form>
    </div>

    <form method="post" class="mb-5">
        @Html.AntiForgeryToken()
        <input type="hidden" name="applicationId" value="@appId" />

        <div class="mb-3">
            <label class="form-label">JSON</label>

            <div class="row align-items-stretch flex-nowrap" style="display:flex; gap: 16px;">
                <div id="editCol" class="col-6">
                    <textarea id="json" name="Json" class="form-control"
                              rows="22" style="width:100%;max-width:100%;height:60vh;box-sizing:border-box;" spellcheck="false">@Model.Json</textarea>
                    <br /><br />
                    <div class="form-text">Þemaya uygun bir JSON girin. Kaydetmeden önce butonlarý kullanarak kontrol edebilirsiniz.</div>
                </div>

                <div id="previewCol" class="col-6" style="visibility:hidden;">
                    <style>
                        #jsonPreview {
                            display: block;
                            background: #0b0b0b;
                            color: #eee;
                            padding: 12px;
                            border-radius: 6px;
                            overflow: auto;
                            width: 100%;
                            height: 60vh;
                            margin: 0;
                            box-sizing: border-box;
                        }

                            #jsonPreview .tok-key {
                                color: #9cdcfe;
                                font-weight: 700;
                            }

                            #jsonPreview .tok-string {
                                color: #ce9178;
                            }

                            #jsonPreview .tok-number {
                                color: #b5cea8;
                            }

                            #jsonPreview .tok-boolean {
                                color: #569cd6;
                            }

                            #jsonPreview .tok-null {
                                color: #808080;
                                font-style: italic;
                            }
                    </style>
                    <pre id="jsonPreview" class="mt-2"></pre>
                    <br />
                    <div class="small text-muted mt-1">Renkli önizleme "JSON'u Biçimlendir" veya "Doðrula" sonrasý görünür.</div>
                </div>
            </div>
        </div>
        <br />
        <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-outline-secondary" id="loadDefaultBtn">Varsayýlaný Yükle</button>
            <button type="button" class="btn btn-secondary" id="formatBtn">JSON'u Biçimlendir</button>
            <button type="button" class="btn btn-outline-primary" id="validateBtn">Doðrula</button>
            <button type="submit" class="btn btn-primary">Kaydet</button>
        </div>
        <br />
        <div id="messages" class="mt-3">
            @if (!string.IsNullOrWhiteSpace(Model.StatusMessage))
            {
                <div class="alert alert-success" style="font-weight:700">@Model.StatusMessage</div>
            }
            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger" style="font-weight:700">
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <div>@error.ErrorMessage</div>
                    }
                </div>
            }
            <div id="clientValidation" class="mb-3" style="display:none;">
                <div id="cvSummary" class="alert" role="alert" style="font-weight:700"></div>
                <div id="cvDetails" class="small"></div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        (function () {
            var ta = document.getElementById('json');
            var previewCol = document.getElementById('previewCol');
            var preview = document.getElementById('jsonPreview');

            var load = document.getElementById('loadDefaultBtn');
            var fmt = document.getElementById('formatBtn');
            var vld = document.getElementById('validateBtn');

            var box = document.getElementById('clientValidation');
            var sum = document.getElementById('cvSummary');
            var det = document.getElementById('cvDetails');

            var defaultPolicy = {
                "version": 1,
                "minLength": 12,
                "maxLength": 128,
                "requireUpper": true,
                "requireLower": true,
                "requireDigit": true,
                "requireSymbol": true,
                "allowedSymbols": "!@@#$%^&*_-+=:?.,;",
                "minDistinctChars": 5,
                "maxRepeatedSequence": 3,
                "blockList": ["password","123456","qwerty","admin"],
                "historyCount": 10,
                "lockoutThreshold": 5,
                "lockoutSeconds": 900,
                "hash": {
                    "algorithm": "Argon2id",
                    "memoryKb": 65536,
                    "parallelism": 2,
                    "iterations": 3,
                    "saltLength": 16,
                    "hashLength": 32,
                    "fallback": { "algorithm": "PBKDF2-SHA512", "iterations": 210000 },
                    "pepperEnabled": false
                }
            };

            function show(ok, title, lines) {
                if (!box || !sum || !det) return;
                box.style.display = 'block';
                sum.className = 'alert ' + (ok ? 'alert-success' : 'alert-danger');
                sum.textContent = title;
                det.innerHTML = '';
                if (lines && lines.length) {
                    var ul = document.createElement('ul');
                    ul.className = 'mb-0';
                    for (var i = 0; i < lines.length; i++) {
                        var li = document.createElement('li');
                        li.textContent = lines[i];
                        ul.appendChild(li);
                    }
                    det.appendChild(ul);
                }
            }

            function escapeHtml(s) { return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

            function renderPreview(json) {
                var esc = escapeHtml(json);
                esc = esc.replace(/(\"(?:\\.|[^\\\"])*\")\s*:/g, function (_, g1) { return '<span class="tok-key">' + g1 + '</span>:'; });
                esc = esc.replace(/(\"(?:\\.|[^\\\"])*\")(?!(\s*:))/g, '<span class="tok-string">$1</span>');
                esc = esc.replace(/\b-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+\-]?\d+)?\b/g, '<span class="tok-number">$&</span>');
                esc = esc.replace(/\b(true|false)\b/g, '<span class="tok-boolean">$1</span>');
                esc = esc.replace(/\bnull\b/g, '<span class="tok-null">null</span>');
                preview.style.display = 'block';
                preview.innerHTML = esc;
            }

            function ensurePreviewVisible() {
                previewCol.style.visibility = 'visible';
            }

            function pretty() {
                try {
                    var parsed = JSON.parse(ta.value);
                    var prettyText = JSON.stringify(parsed, null, 2);
                    ta.value = prettyText;
                    show(true, 'JSON biçimlendirildi.', []);
                    renderPreview(prettyText);
                    ensurePreviewVisible();
                } catch (e) {
                    show(false, 'Geçersiz JSON.', [(e && e.message) ? e.message : String(e)]);
                }
            }

            function validate() {
                var obj;
                try { obj = JSON.parse(ta.value); }
                catch (e) { show(false, 'Geçersiz JSON.', [(e && e.message) ? e.message : String(e)]); return; }

                var errors = [], warns = [], info = [];
                var req = [
                    ['version', 'number'], ['minLength', 'number'], ['maxLength', 'number'],
                    ['requireUpper', 'boolean'], ['requireLower', 'boolean'], ['requireDigit', 'boolean'], ['requireSymbol', 'boolean'],
                    ['allowedSymbols', 'string'], ['minDistinctChars', 'number'], ['maxRepeatedSequence', 'number'],
                    ['blockList', 'object'], ['historyCount', 'number'], ['lockoutThreshold', 'number'], ['lockoutSeconds', 'number'],
                    ['hash', 'object']
                ];
                for (var r = 0; r < req.length; r++) {
                    var key = req[r][0], type = req[r][1];
                    if (!(key in obj)) { errors.push('Eksik alan: ' + key); continue; }
                    if (typeof obj[key] !== type) {
                        if (key === 'blockList' && Array.isArray(obj[key])) { /* ok */ }
                        else { errors.push('Tür hatasý: ' + key + ' (' + (typeof obj[key]) + ' yerine ' + type + ')'); }
                    }
                }
                if (typeof obj.minLength === 'number' && typeof obj.maxLength === 'number' && obj.minLength > obj.maxLength) {
                    errors.push('minLength, maxLength deðerinden büyük olamaz.');
                }
                if (obj.hash && typeof obj.hash === 'object') {
                    var h = obj.hash;
                    info.push('Hash: ' + h.algorithm + ', memoryKb=' + h.memoryKb + ', iterations=' + h.iterations + ', parallelism=' + h.parallelism);
                }

                if (errors.length) show(false, 'Doðrulama baþarýsýz.', errors.concat(warns).concat(info));
                else show(true, 'Doðrulama baþarýlý.', warns.concat(info));

                renderPreview(JSON.stringify(obj, null, 2));
                ensurePreviewVisible();
            }

            function loadDefault() {
                var txt = JSON.stringify(defaultPolicy, null, 2);
                ta.value = txt;
                show(true, 'Varsayýlan JSON yüklendi.', []);
                renderPreview(txt);
                ensurePreviewVisible();
            }

            if (load) load.addEventListener('click', loadDefault);
            if (fmt) fmt.addEventListener('click', pretty);
            if (vld) vld.addEventListener('click', validate);
        })();
    </script>
}