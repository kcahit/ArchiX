<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<CopyTemplates Condition="'$(CopyTemplates)' == ''">1</CopyTemplates>
		<HostPagesRootNamespace Condition="'$(HostPagesRootNamespace)' == ''">$(MSBuildProjectName).Pages</HostPagesRootNamespace>

		<_AxLibraryWebProjectDir>$([System.IO.Path]::GetFullPath("$(MSBuildThisFileDirectory)..\"))</_AxLibraryWebProjectDir>
		<_AxLibraryWebPagesDir>$(_AxLibraryWebProjectDir)Pages\</_AxLibraryWebPagesDir>
		<_AxLibraryWebTemplatesDir>$(_AxLibraryWebProjectDir)Templates\</_AxLibraryWebTemplatesDir>
		<_AxLibraryWebWwwrootDir>$(_AxLibraryWebProjectDir)wwwroot\</_AxLibraryWebWwwrootDir>

		<_AxHostProjectDir>$(MSBuildProjectDirectory)\</_AxHostProjectDir>
		<_AxHostPagesDir>$(_AxHostProjectDir)Pages\</_AxHostPagesDir>
		<_AxHostTemplatesDir>$(_AxHostPagesDir)Templates\</_AxHostTemplatesDir>
		<_AxHostWwwrootDir>$(_AxHostProjectDir)wwwroot\</_AxHostWwwrootDir>

		<_AxLibraryWebRootPagesNamespace>ArchiX.Library.Web.Pages</_AxLibraryWebRootPagesNamespace>
		<_AxLibraryWebTemplatesNamespace>ArchiX.Library.Web.Templates</_AxLibraryWebTemplatesNamespace>
		<_AxHostTemplatesNamespace>$(HostPagesRootNamespace).Templates</_AxHostTemplatesNamespace>
	</PropertyGroup>

	<Target Name="ArchiX_LibraryWeb_CopyToHost" BeforeTargets="BeforeBuild" Condition="'$(CopyTemplates)' == '1'">

		<MakeDir Directories="$(_AxHostPagesDir)" />
		<MakeDir Directories="$(_AxHostTemplatesDir)" />
		<MakeDir Directories="$(_AxHostWwwrootDir)" />

		<ItemGroup>
			<_AxLibWwwrootFiles Include="$(_AxLibraryWebWwwrootDir)**\*" />
			<_AxLibPagesFiles Include="$(_AxLibraryWebPagesDir)**\*" />
			<_AxLibTemplatesFiles Include="$(_AxLibraryWebTemplatesDir)**\*" />
		</ItemGroup>

		<!-- Copy -->
		<Copy SourceFiles="@(_AxLibWwwrootFiles)"
			  DestinationFiles="@(_AxLibWwwrootFiles->'$(_AxHostWwwrootDir)%(RecursiveDir)%(Filename)%(Extension)')"
			  SkipUnchangedFiles="false" OverwriteReadOnlyFiles="true" />

		<Copy SourceFiles="@(_AxLibPagesFiles)"
			  DestinationFiles="@(_AxLibPagesFiles->'$(_AxHostPagesDir)%(RecursiveDir)%(Filename)%(Extension)')"
			  SkipUnchangedFiles="false" OverwriteReadOnlyFiles="true" />

		<Copy SourceFiles="@(_AxLibTemplatesFiles)"
			  DestinationFiles="@(_AxLibTemplatesFiles->'$(_AxHostTemplatesDir)%(RecursiveDir)%(Filename)%(Extension)')"
			  SkipUnchangedFiles="false" OverwriteReadOnlyFiles="true" />

		<!-- Namespace rewrite (PageModels) -->
		<ItemGroup>
			<_AxHostPageModelFiles Include="$(_AxHostPagesDir)**\*.cshtml.cs" Exclude="$(_AxHostTemplatesDir)**\*.cshtml.cs" />
			<_AxHostTemplateModelFiles Include="$(_AxHostTemplatesDir)**\*.cshtml.cs" />
		</ItemGroup>

		<PropertyGroup>
			<_AxRootRewriteFrom>namespace $(_AxLibraryWebRootPagesNamespace)</_AxRootRewriteFrom>
			<_AxRootRewriteTo>namespace $(HostPagesRootNamespace)</_AxRootRewriteTo>

			<_AxTemplateRewriteFrom>namespace $(_AxLibraryWebTemplatesNamespace)</_AxTemplateRewriteFrom>
			<_AxTemplateRewriteTo>namespace $(_AxHostTemplatesNamespace)</_AxTemplateRewriteTo>
		</PropertyGroup>

		<WriteLinesToFile
		  File="@(_AxHostPageModelFiles->'%(FullPath)')"
		  Lines="$([System.IO.File]::ReadAllText('%(FullPath)').Replace('$(_AxRootRewriteFrom)', '$(_AxRootRewriteTo)'))"
		  Overwrite="true"
		  Encoding="UTF-8" />

		<WriteLinesToFile
		  File="@(_AxHostTemplateModelFiles->'%(FullPath)')"
		  Lines="$([System.IO.File]::ReadAllText('%(FullPath)').Replace('$(_AxTemplateRewriteFrom)', '$(_AxTemplateRewriteTo)'))"
		  Overwrite="true"
		  Encoding="UTF-8" />

		<!-- Root _ViewImports -->
		<PropertyGroup>
			<_AxRootViewImportsContent>$([System.IO.File]::ReadAllText('$(_AxLibraryWebPagesDir)_ViewImports.cshtml'))</_AxRootViewImportsContent>
			<_AxRootViewImportsContent>$(_AxRootViewImportsContent.Replace('@using ArchiX.Library.Web', '@using $(MSBuildProjectName)'))</_AxRootViewImportsContent>
			<_AxRootViewImportsContent>$(_AxRootViewImportsContent.Replace('@namespace $(_AxLibraryWebRootPagesNamespace)', '@namespace $(HostPagesRootNamespace)'))</_AxRootViewImportsContent>
		</PropertyGroup>
		<WriteLinesToFile File="$(_AxHostPagesDir)_ViewImports.cshtml" Lines="$(_AxRootViewImportsContent)" Overwrite="true" Encoding="UTF-8" />

		<!-- Templates/Modern/Pages _ViewImports -->
		<PropertyGroup>
			<_AxTemplateViewImportsContent>$([System.IO.File]::ReadAllText('$(_AxLibraryWebTemplatesDir)Modern\Pages\_ViewImports.cshtml'))</_AxTemplateViewImportsContent>
			<_AxTemplateViewImportsContent>$(_AxTemplateViewImportsContent.Replace('@using ArchiX.Library.Web', '@using $(MSBuildProjectName)'))</_AxTemplateViewImportsContent>
			<_AxTemplateViewImportsContent>$(_AxTemplateViewImportsContent.Replace('@namespace ArchiX.Library.Web.Templates', '@namespace $(_AxHostTemplatesNamespace)'))</_AxTemplateViewImportsContent>
		</PropertyGroup>
		<MakeDir Directories="$(_AxHostTemplatesDir)Modern\Pages" />
		<WriteLinesToFile File="$(_AxHostTemplatesDir)Modern\Pages\_ViewImports.cshtml" Lines="$(_AxTemplateViewImportsContent)" Overwrite="true" Encoding="UTF-8" />

	</Target>

</Project>