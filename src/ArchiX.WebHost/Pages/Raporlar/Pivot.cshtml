@page "/Raporlar/Pivot"
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@model ArchiX.Library.Web.Templates.Modern.Pages.Raporlar.PivotModel
@{
    ViewData["Title"] = "Pivot Rapor";
    Layout = null;
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pivot Rapor</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- PivotTable.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.css">
    <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.tr.js"></script>
    <script>
        window.addEventListener('load', function () {
          if (!window.$ || !$.pivotUtilities?.locales?.tr) return;
          const tr = $.pivotUtilities.locales.tr;
          Object.assign(tr.localeStrings, {
            filter: "Deðerleri filtrele",
            filterValues: "Deðerleri filtrele",
            search: "Ara...",
            selectAll: "Tümünü Seç",
            selectNone: "Hiçbiri",
            apply: "Uygula",
            cancel: "Ýptal"
          });
          $.pivotUtilities.locales.tr = tr;
        });
    </script>

    <!-- ArchiX CSS (BODY SCROLL + GRADIENT global.css'de tanýmlý) -->
    <link rel="stylesheet" href="~/css/modern/main.css">
    <link rel="stylesheet" href="~/css/archix.reports.header.css">
    
    <style>
        /* PIVOT PAGE - Gradient arka plan + minimal padding */
        body.pivot-page {
            padding: 15px !important; /* Daha az padding - card yukarýda */
        }
        
        /* SHELL - Card için container */
        .pivot-shell {
            min-width: max-content; /* Ýçeriðe göre geniþle */
            margin: 0 auto;
        }
        
        /* MAIN CARD - Header + Pivot birlikte */
        .pivot-main-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        /* HEADER - Card içinde */
        .pivot-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        
        /* SLICER CARD - Ayrý kart */
        .advanced-search-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 15px;
        }
        
        #pivotContainer {
            margin-top: 20px;
            min-height: 400px;
            min-width: 800px; /* Minimum geniþlik */
            width: max-content; /* Ýçeriðe göre geniþle */
        }
        
        /* PivotTable.js Customization */
        .pvtUi {
            font-size: 0.85rem;
        }
        
        .pvtAxisContainer,
        .pvtVals {
            border: 1px solid #ddd;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
        }
        
        .pvtDropdown {
            border: 1px solid #667eea;
            border-radius: 4px;
            padding: 2px 5px;
        }
        
        .pvtAttr {
            background: #667eea !important;
            color: white !important;
            border: 1px solid #667eea;
            padding: 3px 8px;
            margin: 2px;
            border-radius: 4px;
            cursor: move;
        }
        
        /* Pivot Tablo Baþlýklarý */
        table.pvtTable {
            font-size: 0.85rem;
        }
        
        table.pvtTable thead tr th,
        table.pvtTable tbody tr th {
            background-color: #667eea !important;
            color: white !important;
            border: 1px solid #ddd !important;
            font-weight: 600 !important;
            padding: 8px !important;
        }
        
        /* Pivot Tablo Hücreleri */
        table.pvtTable tbody tr td {
            background-color: white !important;
            color: #333 !important;
            border: 1px solid #ddd !important;
            text-align: center !important;
            padding: 6px !important;
        }
        
        /* TOPLAM SATIRLARI - SARI */
        table.pvtTable .pvtTotal,
        table.pvtTable .pvtGrandTotal,
        table.pvtTable .pvtRowTotal,
        table.pvtTable .pvtColTotal {
            background-color: #ffc107 !important;
            color: #333 !important;
            font-weight: 700 !important;
            font-size: 0.9rem !important;
        }
        
        /* Barchart için çubuklar */
        table.pvtTable .pvtVal {
            text-align: center !important;
        }
        
        table.pvtTable .pvtVal .bar {
            display: inline-block;
            height: 20px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            margin-right: 5px;
            vertical-align: middle;
            border-radius: 3px;
        }
        
        /* Row Label Hücreleri */
        table.pvtTable .pvtRowLabel,
        table.pvtTable .pvtColLabel {
            background-color: #667eea !important;
            color: white !important;
            font-weight: 600 !important;
        }
        
        /* Hover Efekti */
        table.pvtTable tbody tr:hover td {
            background-color: #f8f9fa !important;
        }
    </style>
</head>
<body class="pivot-page">
    <div class="container-fluid pivot-shell">
        
        <!-- ANA CARD - Header + Pivot Birlikte -->
        <div class="pivot-main-card">
            <!-- Header -->
            <div class="pivot-header">
                <div id="reportHeader">
                    <!-- Header will be injected by archix.reports.header.js -->
                </div>
            </div>

            <!-- Pivot Container -->
            <div id="pivotContainer"></div>
        </div>

        <!-- Geliþmiþ Arama - Slicer Paneli (Ayrý Card) -->
        <div class="collapse mb-3" id="advancedSearch">
            <div class="card advanced-search-card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="column-selector-panel">
                                <h6 class="column-selector-title">
                                    <span class="column-selector-title-group">
                                        <input type="checkbox" class="column-selector-toggle" id="toggleAllColumns" onchange="toggleAllColumns()" title="Hepsi/Hiçbiri">
                                        Kolonlar
                                    </span>
                                    <button onclick="clearAdvancedFilters()" class="btn-advanced-clear" title="Geliþmiþ Filtreleri Temizle">
                                        Temizle
                                    </button>
                                </h6>
                                <div id="columnCheckList"></div>
                            </div>
                        </div>
                        <div class="col-md-10">
                            <div id="slicerContainer" style="display: flex; flex-wrap: wrap;">
                                <div id="noSlicerMsg" class="grid-no-slicer">
                                    <i class="bi bi-arrow-left"></i> Soldaki listeden kolon seçin
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- PivotTable.js -->
    <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
    
    <!-- Chart.js for renderers -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- ArchiX Reports Core -->
    <script src="~/js/archix.reports.header.js"></script>
    <script src="~/js/archix.reports.slicer.core.js"></script>
    
    <script>
        const data = [
            { id: 1, name: "Ahmet Yýlmaz", email: "ahmet@example.com", phone: "0532 123 4567", department: "IT", salary: 15000, experience: 5, city: "Istanbul", position: "Yazýlým Geliþtirici", startDate: "2019-03-15", status: "Aktif" },
            { id: 2, name: "Ayþe Demir", email: "ayse@example.com", phone: "0533 234 5678", department: "Satýþ", salary: 12000, experience: 3, city: "Ankara", position: "Satýþ Temsilcisi", startDate: "2021-06-20", status: "Aktif" },
            { id: 3, name: "Mehmet Kaya", email: "mehmet@example.com", phone: "0534 345 6789", department: "Ýnsan Kaynaklarý", salary: 18000, experience: 8, city: "Izmir", position: "ÝK Müdürü", startDate: "2016-01-10", status: "Pasif" },
            { id: 4, name: "Fatma Çelik", email: "fatma@example.com", phone: "0535 456 7890", department: "Pazarlama", salary: 14000, experience: 4, city: "Bursa", position: "Pazarlama Uzmaný", startDate: "2020-09-05", status: "Beklemede" },
            { id: 5, name: "Ali Öz", email: "ali@example.com", phone: "0536 567 8901", department: "IT", salary: 16500, experience: 6, city: "Istanbul", position: "Sistem Yöneticisi", startDate: "2018-11-12", status: "Aktif" },
            { id: 6, name: "Zeynep Þahin", email: "zeynep@example.com", phone: "0537 678 9012", department: "Satýþ", salary: 11000, experience: 2, city: "Antalya", position: "Satýþ Danýþmaný", startDate: "2022-02-28", status: "Aktif" },
            { id: 7, name: "Can Arslan", email: "can@example.com", phone: "0538 789 0123", department: "IT", salary: 17000, experience: 7, city: "Ankara", position: "Kýdemli Geliþtirici", startDate: "2017-05-18", status: "Pasif" },
            { id: 8, name: "Elif Kurt", email: "elif@example.com", phone: "0539 890 1234", department: "Pazarlama", salary: 13500, experience: 4, city: "Istanbul", position: "Dijital Pazarlama", startDate: "2020-07-22", status: "Aktif" },
            { id: 9, name: "Burak Aydýn", email: "burak@example.com", phone: "0540 901 2345", department: "Ýnsan Kaynaklarý", salary: 12500, experience: 3, city: "Izmir", position: "ÝK Uzmaný", startDate: "2021-04-14", status: "Beklemede" },
            { id: 10, name: "Selin Türk", email: "selin@example.com", phone: "0541 012 3456", department: "Satýþ", salary: 13000, experience: 5, city: "Bursa", position: "Bölge Müdürü", startDate: "2019-08-30", status: "Aktif" },
            { id: 11, name: "Deniz Yýldýz", email: "deniz@example.com", phone: "0542 111 2222", department: "IT", salary: 19000, experience: 10, city: "Istanbul", position: "IT Müdürü", startDate: "2014-12-01", status: "Aktif" },
            { id: 12, name: "Ece Kartal", email: "ece@example.com", phone: "0543 222 3333", department: "Pazarlama", salary: 12000, experience: 2, city: "Ankara", position: "Sosyal Medya Uzmaný", startDate: "2022-05-17", status: "Pasif" },
            { id: 13, name: "Emre Koç", email: "emre@example.com", phone: "0544 333 4444", department: "IT", salary: 15500, experience: 5, city: "Izmir", position: "Veri Analisti", startDate: "2019-10-08", status: "Aktif" },
            { id: 14, name: "Gizem Acar", email: "gizem@example.com", phone: "0545 444 5555", department: "Satýþ", salary: 11500, experience: 3, city: "Antalya", position: "Satýþ Uzmaný", startDate: "2021-03-25", status: "Aktif" },
            { id: 15, name: "Hakan Demir", email: "hakan@example.com", phone: "0546 555 6666", department: "Pazarlama", salary: 16000, experience: 7, city: "Istanbul", position: "Marka Müdürü", startDate: "2017-07-19", status: "Aktif" },
            { id: 16, name: "Ýrem Yalçýn", email: "irem@example.com", phone: "0547 666 7777", department: "Ýnsan Kaynaklarý", salary: 14500, experience: 6, city: "Bursa", position: "ÝK Koordinatörü", startDate: "2018-09-11", status: "Aktif" },
            { id: 17, name: "Kerem Özkan", email: "kerem@example.com", phone: "0548 777 8888", department: "IT", salary: 18500, experience: 9, city: "Ankara", position: "Yazýlým Mimarý", startDate: "2015-02-03", status: "Pasif" },
            { id: 18, name: "Lale Kara", email: "lale@example.com", phone: "0549 888 9999", department: "Satýþ", salary: 13500, experience: 4, city: "Istanbul", position: "Kurumsal Satýþ", startDate: "2020-11-27", status: "Aktif" },
            { id: 19, name: "Mert Çetin", email: "mert@example.com", phone: "0530 999 0000", department: "Pazarlama", salary: 12500, experience: 3, city: "Izmir", position: "Ýçerik Üreticisi", startDate: "2021-08-16", status: "Beklemede" },
            { id: 20, name: "Nil Þen", email: "nil@example.com", phone: "0531 000 1111", department: "IT", salary: 17500, experience: 8, city: "Ankara", position: "DevOps Mühendisi", startDate: "2016-06-22", status: "Aktif" },
            { id: 21, name: "Oðuz Taþ", email: "oguz@example.com", phone: "0532 111 2222", department: "Satýþ", salary: 14000, experience: 5, city: "Bursa", position: "Satýþ Müdürü", startDate: "2019-04-09", status: "Aktif" },
            { id: 22, name: "Pelin Ay", email: "pelin@example.com", phone: "0533 222 3333", department: "Ýnsan Kaynaklarý", salary: 13000, experience: 4, city: "Istanbul", position: "Ýþe Alým Uzmaný", startDate: "2020-12-14", status: "Aktif" },
            { id: 23, name: "Rýza Ulu", email: "riza@example.com", phone: "0534 333 4444", department: "Pazarlama", salary: 15500, experience: 6, city: "Antalya", position: "Pazarlama Müdürü", startDate: "2018-03-07", status: "Pasif" },
            { id: 24, name: "Seda Akýn", email: "seda@example.com", phone: "0535 444 5555", department: "IT", salary: 16000, experience: 6, city: "Izmir", position: "Test Uzmaný", startDate: "2018-08-21", status: "Aktif" },
            { id: 25, name: "Tolga Yurt", email: "tolga@example.com", phone: "0536 555 6666", department: "Satýþ", salary: 12000, experience: 2, city: "Ankara", position: "Satýþ Elemaný", startDate: "2022-01-11", status: "Aktif" },
            { id: 26, name: "Ufuk Aydýn", email: "ufuk@example.com", phone: "0537 666 7777", department: "Pazarlama", salary: 14500, experience: 5, city: "Istanbul", position: "SEO Uzmaný", startDate: "2019-09-26", status: "Aktif" },
            { id: 27, name: "Vildan Er", email: "vildan@example.com", phone: "0538 777 8888", department: "Ýnsan Kaynaklarý", salary: 11500, experience: 2, city: "Bursa", position: "ÝK Asistaný", startDate: "2022-07-04", status: "Beklemede" },
            { id: 28, name: "Yaðmur Kýlýç", email: "yagmur@example.com", phone: "0539 888 9999", department: "IT", salary: 20000, experience: 12, city: "Istanbul", position: "CTO", startDate: "2012-10-15", status: "Aktif" },
            { id: 29, name: "Zafer Güneþ", email: "zafer@example.com", phone: "0540 999 0000", department: "Satýþ", salary: 15000, experience: 7, city: "Ankara", position: "Satýþ Direktörü", startDate: "2017-11-30", status: "Aktif" },
            { id: 30, name: "Aslý Öztürk", email: "asli@example.com", phone: "0541 000 1111", department: "Pazarlama", salary: 13000, experience: 4, city: "Izmir", position: "Reklam Uzmaný", startDate: "2020-05-13", status: "Pasif" },
            { id: 31, name: "Baran Çakýr", email: "baran@example.com", phone: "0542 111 2222", department: "IT", salary: 17000, experience: 7, city: "Bursa", position: "Güvenlik Uzmaný", startDate: "2017-02-28", status: "Aktif" },
            { id: 32, name: "Canan Tekin", email: "canan@example.com", phone: "0543 222 3333", department: "Ýnsan Kaynaklarý", salary: 16500, experience: 8, city: "Istanbul", position: "ÝK Direktörü", startDate: "2016-08-08", status: "Aktif" },
            { id: 33, name: "Deniz Arslan", email: "deniz2@example.com", phone: "0544 333 4444", department: "Satýþ", salary: 11000, experience: 1, city: "Antalya", position: "Stajyer", startDate: "2023-03-01", status: "Aktif" },
            { id: 34, name: "Eda Polat", email: "eda@example.com", phone: "0545 444 5555", department: "Pazarlama", salary: 12500, experience: 3, city: "Ankara", position: "Grafik Tasarýmcý", startDate: "2021-09-20", status: "Beklemede" },
            { id: 35, name: "Fikret Yýldýrým", email: "fikret@example.com", phone: "0546 555 6666", department: "IT", salary: 16500, experience: 6, city: "Izmir", position: "Network Uzmaný", startDate: "2018-04-17", status: "Aktif" },
            { id: 36, name: "Gül Taþkýn", email: "gul@example.com", phone: "0547 666 7777", department: "Satýþ", salary: 14500, experience: 6, city: "Istanbul", position: "Ýhracat Müdürü", startDate: "2018-10-23", status: "Aktif" },
            { id: 37, name: "Halil Kurt", email: "halil@example.com", phone: "0548 777 8888", department: "Pazarlama", salary: 18000, experience: 9, city: "Bursa", position: "CMO", startDate: "2015-12-05", status: "Aktif" },
            { id: 38, name: "Ýpek Çalýþkan", email: "ipek@example.com", phone: "0549 888 9999", department: "Ýnsan Kaynaklarý", salary: 12000, experience: 3, city: "Ankara", position: "Eðitim Uzmaný", startDate: "2021-07-14", status: "Pasif" },
            { id: 39, name: "Kaan Durmuþ", email: "kaan@example.com", phone: "0530 999 0000", department: "IT", salary: 15000, experience: 5, city: "Izmir", position: "Mobil Geliþtirici", startDate: "2019-05-29", status: "Aktif" },
            { id: 40, name: "Leyla Berk", email: "leyla@example.com", phone: "0531 000 1111", department: "Satýþ", salary: 13500, experience: 4, city: "Istanbul", position: "E-ticaret Uzmaný", startDate: "2020-08-11", status: "Aktif" },
            { id: 41, name: "Mustafa Eren", email: "mustafa@example.com", phone: "0532 111 2222", department: "Pazarlama", salary: 14000, experience: 5, city: "Antalya", position: "Etkinlik Yöneticisi", startDate: "2019-06-18", status: "Beklemede" },
            { id: 42, name: "Nalan Kaya", email: "nalan@example.com", phone: "0533 222 3333", department: "IT", salary: 19500, experience: 11, city: "Ankara", position: "Proje Müdürü", startDate: "2013-09-10", status: "Aktif" },
            { id: 43, name: "Onur Aydýn", email: "onur@example.com", phone: "0534 333 4444", department: "Satýþ", salary: 12500, experience: 3, city: "Bursa", position: "Müþteri Ýliþkileri", startDate: "2021-11-22", status: "Aktif" },
            { id: 44, name: "Pýnar Yüksel", email: "pinar@example.com", phone: "0535 444 5555", department: "Ýnsan Kaynaklarý", salary: 13500, experience: 4, city: "Istanbul", position: "Performans Uzmaný", startDate: "2020-10-06", status: "Aktif" },
            { id: 45, name: "Recep Þimþek", email: "recep@example.com", phone: "0536 555 6666", department: "Pazarlama", salary: 11500, experience: 2, city: "Izmir", position: "Video Editörü", startDate: "2022-04-19", status: "Pasif" },
            { id: 46, name: "Selin Özer", email: "selin2@example.com", phone: "0537 666 7777", department: "IT", salary: 16000, experience: 6, city: "Ankara", position: "Veri Bilimci", startDate: "2018-07-12", status: "Aktif" },
            { id: 47, name: "Taner Aslan", email: "taner@example.com", phone: "0538 777 8888", department: "Satýþ", salary: 17000, experience: 9, city: "Istanbul", position: "Anahtar Müþteri", startDate: "2015-05-25", status: "Aktif" },
            { id: 48, name: "Ümit Karaca", email: "umit@example.com", phone: "0539 888 9999", department: "Pazarlama", salary: 13000, experience: 3, city: "Bursa", position: "PR Uzmaný", startDate: "2021-12-08", status: "Aktif" },
            { id: 49, name: "Volkan Özdemir", email: "volkan@example.com", phone: "0540 999 0000", department: "Ýnsan Kaynaklarý", salary: 19000, experience: 10, city: "Antalya", position: "ÝK Genel Müdürü", startDate: "2014-03-20", status: "Aktif" },
            { id: 50, name: "Yasemin Tan", email: "yasemin@example.com", phone: "0541 000 1111", department: "IT", salary: 18000, experience: 8, city: "Izmir", position: "UX/UI Tasarýmcý", startDate: "2016-11-14", status: "Beklemede" },
            { id: 51, name: "Zeki Bulut", email: "zeki@example.com", phone: "0542 111 2222", department: "Satýþ", salary: 14500, experience: 5, city: "Ankara", position: "Teknik Satýþ", startDate: "2019-02-07", status: "Aktif" },
            { id: 52, name: "Aylin Erdoðan", email: "aylin@example.com", phone: "0543 222 3333", department: "Pazarlama", salary: 15000, experience: 6, city: "Istanbul", position: "Marka Stratejisti", startDate: "2018-06-30", status: "Aktif" },
            { id: 53, name: "Barýþ Yaman", email: "baris@example.com", phone: "0544 333 4444", department: "IT", salary: 21000, experience: 13, city: "Bursa", position: "Baþkan Yardýmcýsý", startDate: "2011-08-16", status: "Aktif" },
            { id: 54, name: "Ceyda Koçak", email: "ceyda@example.com", phone: "0545 444 5555", department: "Satýþ", salary: 13000, experience: 4, city: "Antalya", position: "Bayi Yöneticisi", startDate: "2020-03-24", status: "Pasif" },
            { id: 55, name: "Doðan Þener", email: "dogan@example.com", phone: "0546 555 6666", department: "Ýnsan Kaynaklarý", salary: 15500, experience: 7, city: "Izmir", position: "Bordro Uzmaný", startDate: "2017-09-02", status: "Aktif" }
        ];

        const fieldNames = {
            name: "Ýsim",
            email: "Email",
            phone: "Telefon",
            department: "Departman",
            salary: "Maaþ",
            experience: "Tecrübe",
            city: "Þehir",
            position: "Pozisyon",
            startDate: "Baþlangýç",
            status: "Durum"
        };

        // Initialize Header
        ArchiXReportsHeader.init({
            title: 'Pivot Rapor',
            icon: 'bi-grid-3x3-gap-fill',
            showExport: false,
            showAdvancedSearch: true,
            onReset: function() {
                ArchiXReportsSlicer.resetAllFilters();
                refreshPivot();
            }
        });

        // Initialize Slicer
        ArchiXReportsSlicer.init(data, fieldNames, function(filteredData) {
            ArchiXReportsHeader.updateRecordCount(filteredData.length);
            refreshPivot();
        });

        // TABLE BARCHART RENDERER - Çubuk grafikli görünüm
        function initPivot() {
            $("#pivotContainer").pivotUI(
                ArchiXReportsSlicer.filteredData,
                {
                    rows: ["department", "city"],
                    cols: ["status"],
                    vals: ["salary"],
                    aggregatorName: "Sum",
                    rendererName: "Table Barchart",
                    hiddenAttributes: ["id", "email", "phone"],
                    unusedAttrsVertical: false,
                    menuLimit: 500
                },
                true,
                "tr"
            );
        }

        function refreshPivot() {
            const config = $("#pivotContainer").data("pivotUIOptions");
            if (config) {
                $("#pivotContainer").pivotUI(ArchiXReportsSlicer.filteredData, config, true, "tr");
            } else {
                initPivot();
            }
        }

        // Global functions for onclick handlers
        function clearAdvancedFilters() { ArchiXReportsSlicer.clearAdvancedFilters(); }
        function toggleAllColumns() { ArchiXReportsSlicer.toggleAllColumns(); }

        $(document).ready(function() {
            initPivot();
            ArchiXReportsHeader.updateRecordCount(data.length);
        });
    </script>
</body>
</html>
